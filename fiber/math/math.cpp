#include <fiber/math/math.hpp>

namespace fiber{

    float frexp10(float value, int* exp10_out){
        // reinterpret float bits
        union { float f; uint32_t i; } u = { value };

        // extract base-2 exponent
        const int raw_exp2 = ((u.i >> 23) & 0xFF);
        const int exp2 = raw_exp2 - 127;

        // normalize mantissa to [0.5, 1.0)
        u.i = (u.i & 0x807FFFFF) | (127 << 23);

        // approximate log10(2) * exp2 = exp10
        int exp10 = (exp2 * 1233) >> 12;

        // precise version
        // ---------------
        //
        // lookup table calculates the earlier std::exp2((exponent_b10_f - exponent_b10_i) * log2_10)
        const float correction[] = {0.587747,  0.117549,  0.235099,  0.470198,  0.940395,  0.188079,  0.376158,  0.752316,  0.150463,  0.300927,  0.601853,  0.120371,  0.240741,  0.481482,  0.962965,  0.192593,  0.385186,  0.770372,  0.154074,  0.308149,  0.616298,  0.123260,  0.246519,  0.493038,  0.986076,  0.197215,  0.394430,  0.788861,  0.157772,  0.315544,  0.631089,  0.126218,  0.252435,  0.504871,  0.100974,  0.201948,  0.403897,  0.807794,  0.161559,  0.323117,  0.646235,  0.129247,  0.258494,  0.516988,  0.103398,  0.206795,  0.413590,  0.827181,  0.165436,  0.330872,  0.661744,  0.132349,  0.264698,  0.529396,  0.105879,  0.211758,  0.423516,  0.847033,  0.169407,  0.338813,  0.677626,  0.135525,  0.271051,  0.542101,  0.108420,  0.216840,  0.433681,  0.867362,  0.173472, 0.346945,  0.693889,  0.138778,  0.277556,  0.555112,  0.111022,  0.222045,  0.444089,  0.888178,  0.177636,  0.355271,  0.710543,  0.142109,  0.284217,  0.568434,  0.113687,  0.227374,  0.454747,  0.909495,  0.181899,  0.363798,  0.727596,  0.145519,  0.291038,  0.582077,  0.116415, 0.232831,  0.465661,  0.931323,  0.186265,  0.372529,  0.745058,  0.149012,  0.298023,  0.596046,  0.119209,  0.238419,  0.476837,  0.953674,  0.190735,  0.381470,  0.762939,  0.152588,  0.305176,  0.610352,  0.122070,  0.244141,  0.488281,  0.976562,  0.195312,  0.390625,  0.781250,  0.156250,  0.312500,  0.625000,  0.125000,  0.250000,  0.500000,  1.000000,  2.000000,  4.000000,  8.000000,  1.600000,  3.200000,  6.400000,  1.280000,  2.560000,  5.120000,  1.024000,  2.048000,  4.096000,  8.192000,  1.638400,  3.276800,  6.553600,  1.310720,  2.621440,  5.242880,  1.048576,  2.097152,  4.194304,  8.388608,  1.677722,  3.355443,  6.710886,  1.342177,  2.684355,  5.368709,  1.073742,  2.147484,  4.294967,  8.589935,  1.717987,  3.435974,  6.871948,  1.374390,  2.748779,  5.497558,  1.099512,  2.199023,  4.398047,  8.796093,  1.759219,  3.518437,  7.036874,  1.407375,  2.814750,  5.629500,  1.125900,  2.251800,  4.503600,  9.007199,  1.801440,  3.602880,  7.205759,  1.441152,  2.882304,  5.764608,  1.152922,  2.305843,  4.611686, 9.223372,  1.844674,  3.689349,  7.378698,  1.475740,  2.951479,  5.902958,  1.180592,  2.361183,  4.722366,  9.444733,  1.888947,  3.777893,  7.555786,  1.511157,  3.022315,  6.044629,  1.208926,  2.417852,  4.835703,  9.671407,  1.934281,  3.868563,  7.737125,  1.547425,  3.094850,  6.189700,  1.237940,  2.475880,  4.951760,  9.903520,  1.980704,  3.961408,  7.922816,  1.584563,  3.169127,  6.338253,  1.267651,  2.535301,  5.070602,  1.014120,  2.028241,  4.056482,  8.112964,  1.622593,  3.245186,  6.490371,  1.298074,  2.596148,  5.192297,  1.038459,  2.076919,  4.153837,  8.307675,  1.661535,  3.323070,  6.646140,  1.329228,  2.658456,  5.316912,  1.063382,  2.126765,  4.253530,  8.507059,  1.701412};
        float mant10 = u.f * correction[raw_exp2];
        
        // RAM friendly but inprecise version
        // ----------------------------------
        //
        // replace original float table with uint16_t encoded floats to save memory
        //constexpr uint16_t negative_correction[] = {38518, 7703, 15407, 30814, 61629, 12325, 24651, 49303, 9860, 19721, 39443, 7888, 15777, 31554, 63108, 12621, 25243, 50487, 10097, 20194, 40389, 8077, 16155, 32311, 64623, 12924, 25849, 51698, 10339, 20679, 41359, 8271, 16543, 33087, 6617, 13234, 26469, 52939, 10587, 21175, 42351, 8470, 16940, 33881, 6776, 13552, 27105, 54210, 10842, 21684, 43368, 8673, 17347, 34694, 6938, 13877, 27755, 55511, 11102, 22204, 44408, 8881, 17763, 35527, 7105, 14210, 28421, 56843, 11368, 22737, 45474, 9094, 18189, 36379, 7275, 14551, 29103, 58207, 11641, 23283, 46566, 9313, 18626, 37252, 7450, 14901, 29802, 59604, 11920, 23841, 47683, 9536, 19073, 38146, 7629, 15258, 30517, 61035, 12207, 24414, 48828, 9765, 19531, 39062, 7812, 15624, 31249, 62499, 12499, 24999, 49999, 9999, 20000, 40000, 8000, 16000, 31999, 63999, 12799, 25599, 51200, 10240, 20480, 40960, 8192, 16384};
        //constexpr uint16_t positive_correction[] = {6553, 13107, 26214, 52428, 10485, 20971, 41943, 8388, 16777, 33554, 6710, 13421, 26843, 53687, 10737, 21474, 42949, 8589, 17179, 34359, 6871, 13743, 27487, 54975, 10995, 21990, 43980, 8796, 17592, 35184, 7036, 14073, 28147, 56294, 11258, 22517, 45035, 9007, 18014, 36028, 7205, 14411, 28823, 57646, 11529, 23058, 46116, 9223, 18446, 36893, 7378, 14757, 29514, 59029, 11805, 23611, 47223, 9444, 18889, 37778, 7555, 15111, 30223, 60446, 12089, 24178, 48357, 9671, 19342, 38685, 7737, 15474, 30948, 61897, 12379, 24758, 49517, 9903, 19807, 39614, 7922, 15845, 31691, 63382, 12676, 25353, 50706, 10141, 20282, 40564, 8112, 16225, 32451, 64903, 12980, 25961, 51922, 10384, 20769, 41538, 8307, 16615, 33230, 6646, 13292, 26584, 53169, 10633, 21267, 42535, 8507, 17014, 34028, 6805, 13611, 27222, 54445, 10889, 21778, 43556, 8711, 17422, 34844, 6968, 13937, 27875, 55751, 11150};
        //constexpr float negative_uint16_to_float = 1.52587890625e-05f;
        //constexpr float positive_uint16_to_float = 0.000152587890625f;
        //float mant10;
        //
        //if(exp2 < 0){
        //    mant10 = u.f * negative_correction[raw_exp2] * negative_uint16_to_float;
        //}else{
        //    mant10 = u.f * positive_correction[exp2] * positive_uint16_to_float;
        //}

        if(mant10 >= 10.f){
            mant10 /= 10.f;
            exp10 += 1;
        }else if(mant10 < 1.f){
            mant10 *= 10.f;
            exp10 -= 1;
        }

        *exp10_out = exp10;
        return mant10;

        /*
        
        correction factors have been calculated as follows:
        import numpy as np
        import matplotlib.pyplot as plt

        exp2 = np.arange(-127, 128)
        exp10f = exp2 * np.log10(2)
        exp10i = exp10f.astype(np.int32)
        error = exp10f - exp10i
        correction = np.exp2(error * np.log2(10))

        exp2 = np.arange(-127, -1)
        exp10f = exp2 * np.log10(2)
        exp10i = exp10f.astype(np.int32)
        error = exp10f - exp10i
        negative_correction = np.exp2(error * np.log2(10))

        negative_correction_i16 = (negative_correction * 65536).astype(np.uint32)
        print("negative correction")
        for elem in negative_correction_i16:
            print(f"{elem}, ", end='')
        print("")
        print("")
        print(f"scaling factor: {1/65536.0}")
        print("")
        print("")

        exp2 = np.arange(0, 128)
        exp10f = exp2 * np.log10(2)
        exp10i = exp10f.astype(np.int32)
        error = exp10f - exp10i
        positive_correction = np.exp2(error * np.log2(10))

        positive_correction_i16 = (positive_correction * 6553.6).astype(np.uint32)
        print("positive correction")
        for elem in positive_correction_i16:
            print(f"{elem}, ", end='')
            
        print("")
        print("")
        print(f"scaling factor: {1/6553.6}")
        print("")
        print("")
        
        */
    }

}