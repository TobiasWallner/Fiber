<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fiber: getting_started_stm32_example</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">fiber
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d9/dcc/getting_started_stm32_example.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">getting_started_stm32_example</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>tutorial on setting up your toolchain</p>
<h1><a class="anchor" id="autotoc_md45"></a>
STM32 Example</h1>
<h1><a class="anchor" id="section_getting_started_stm32_example_overview"></a>
Overview</h1>
<p>This tutorial will walk you through the process of moving away from vendor-specific IDEs (like STM32CubeIDE) and transitioning to a modern, portable build and debug setup using open-source tools. The following components will be covered:</p>
<ul>
<li>CMake and Ninja for build generation</li>
<li>GCC as a compiler toolchain</li>
<li>Make and Python for scripting</li>
<li>CPM.cmake for package management</li>
<li>OpenOCD and GDB for debugging</li>
<li>Full integration into Visual Studio Code (VSCode)</li>
</ul>
<p>The goal is to establish a reusable and consistent embedded development workflow across microcontrollers and platforms.</p>
<h1><a class="anchor" id="section_getting_started_stm32_use_ide_generate_skeleton"></a>
Use STM32CubeIDE to generate project skeleton</h1>
<p>Even though our goal is to become independent from the embedded systems IDEs (like the CubeIDE), it provides a convenient GUI to initialize clocks, peripherals, and generate vendor-specific boilerplate like:</p>
<ul>
<li>Linker scripts</li>
<li>Startup files</li>
<li>HAL/CMSIS initialization</li>
</ul>
<hr  />
<ol type="1">
<li>Open STM32CubeIDE.</li>
<li>Create a new STM32 project: <code>file &gt; new &gt; STM32 Project</code></li>
<li>Choose your MCU (e.g. STM32F446RE) or development board.</li>
<li>Configure clocks, peripherals, middleware, and project settings as desired.</li>
<li>Generate code via <code>Project &gt; Generate Code</code>.</li>
</ol>
<p>This will create a folder structure similar to (depending on your actuar board and MCU):</p>
<div class="fragment"><div class="line">📁 root/</div>
<div class="line">├── 📁 Core/</div>
<div class="line">│   ├── 📁 Inc/                       # Header files</div>
<div class="line">│   │   ├── main.h                    # Main application header</div>
<div class="line">│   │   ├── stm32f4xx_hal_conf.h      # HAL configuration macros</div>
<div class="line">│   │   └── stm32f4xx_it.h            # Interrupt service routine declarations</div>
<div class="line">│   └── 📁 Src/                       # Source files</div>
<div class="line">│       ├── main.c                    # Application entry point</div>
<div class="line">│       ├── stm32f4xx_hal_msp.c       # HAL initialization (MSP - MCU Support Package)</div>
<div class="line">│       ├── stm32f4xx_it.c            # Interrupt service routines</div>
<div class="line">│       ├── syscalls.c                # System stubs (e.g., `_kill`, `_write`, `_read`)</div>
<div class="line">│       ├── sysmem.c                  # Defines `_sbrk()` for dynamic memory (malloc)</div>
<div class="line">│       └── system_stm32f4xx.c        # System clock and configuration setup</div>
<div class="line">├── 📁 Drivers/                       # Vendor-supplied HAL and CMSIS drivers</div>
<div class="line">├── 📁 Startup/</div>
<div class="line">│   └── startup_stm32f446retx.s       # MCU startup code and vector table</div>
<div class="line">└── STM32F446RETX_FLASH.ld            # Linker script defining memory layout</div>
</div><!-- fragment --><p>These files will serve as the foundation of the project. Of course later you might want to write yor own linker scripts, but this is a nice starting point</p>
<h1><a class="anchor" id="section_getting_started_stm32_create_your_buildsystem"></a>
Create your own build system</h1>
<p>Instead of building the project with the IDE, we will set up a modern CMake-based build system.</p>
<p>To seperate the application code from the MCU setup, auto generated files and initialisations it is good practice to create a sub-folder called <code>Application/</code> containing your application code and let the main function call into your application, while vendor files remain mostly untouched in <code>Core/</code> and <code>Drivers/</code>.</p>
<p>Another approach would be to make your application a standalone library that only works with interfaces and abstract device drivers. The vendor generated root folder - plus some glue logic - will then provide concrete devices like pins, timers and communications to your application. That way you have fully portable applications that do not depend on microcontrollers or boards. (Just in case a new chip shortage comes accross).</p>
<p>Create the following <code>CMakeLists.txt</code> in the root folder:</p>
<div class="fragment"><div class="line">cmake_minimum_required(VERSION 3.16)</div>
<div class="line"> </div>
<div class="line"># define project name and declare that we are going to use assembly (ASM), C and C++ (CXX)</div>
<div class="line">project(ProjectName ASM C CXX)</div>
<div class="line"> </div>
<div class="line"># include the package manager </div>
<div class="line">include(CPM.cmake)</div>
<div class="line"> </div>
<div class="line">##########################################################################</div>
<div class="line">#                               Libraries</div>
<div class="line">##########################################################################</div>
<div class="line"> </div>
<div class="line"># Add the application code as a standalone library</div>
<div class="line">add_subdirectory(Application)</div>
<div class="line"> </div>
<div class="line">##########################################################################</div>
<div class="line">#           Get HAL, CMSIS and auto generated Core-Files</div>
<div class="line">##########################################################################</div>
<div class="line"> </div>
<div class="line"># Get all autogenerated files</div>
<div class="line"># HAL, CMSIS, and Core-Files</div>
<div class="line">file(GLOB_RECURSE Core_Src_Files &quot;Core/Src/*.c&quot;)</div>
<div class="line">file(GLOB_RECURSE HAL_Src_Files &quot;Drivers/*.c&quot;)</div>
<div class="line">set(CORE_SRC_FILES</div>
<div class="line">    Core/Startup/startup_stm32f446retx.s</div>
<div class="line">    ${Core_Src_Files}</div>
<div class="line">    ${HAL_Src_Files}</div>
<div class="line">)</div>
<div class="line">set(CORE_INC_DIRS</div>
<div class="line">    Core/Inc</div>
<div class="line">    Drivers/CMSIS/Include</div>
<div class="line">    Drivers/CMSIS/Device/ST/STM32F4xx/Include</div>
<div class="line">    Drivers/STM32F4xx_HAL_Driver/Inc</div>
<div class="line">    Drivers/STM32F4xx_HAL_Driver/Inc/Legacy</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">##########################################################################</div>
<div class="line">#                           Define project files</div>
<div class="line">##########################################################################</div>
<div class="line"> </div>
<div class="line"># create an executable that can be flashed to the MCU with the name `main` (or a different name)</div>
<div class="line"># pass it the source files that should be compiled</div>
<div class="line">add_executable(main </div>
<div class="line">    ${CORE_SRC_FILES}</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># Add the include search directories to the `main` target</div>
<div class="line">target_include_directories(main</div>
<div class="line">    PUBLIC </div>
<div class="line">        ${CORE_INC_DIRS}</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># Optional: Fiber provides some very useful and efficient hardware drivers. </div>
<div class="line"># To make use of them pass the include directories to fiber as well.</div>
<div class="line">target_include_directories(fiber PUBLIC ${CORE_INC_DIRS})</div>
<div class="line"> </div>
<div class="line"># link the actual application to the main target</div>
<div class="line">target_link_libraries(main PUBLIC App)</div>
<div class="line"> </div>
<div class="line"># define the output name to be an `*.elf` file used for flashing.</div>
<div class="line">set_target_properties(main PROPERTIES OUTPUT_NAME &quot;main.elf&quot;)</div>
</div><!-- fragment --><p>Then, create a separate toolchain file toolchain.cmake to define cross-compilation settings for the ARM Cortex-M MCU: </p><div class="fragment"><div class="line"># Compile generic code that runs bare metal and not within an encapsulating operating system</div>
<div class="line"># https://cmake.org/cmake/help/latest/variable/CMAKE_SYSTEM_NAME.html</div>
<div class="line">set(CMAKE_SYSTEM_NAME Generic)</div>
<div class="line"> </div>
<div class="line"># Define the processor arcitecture, for the STM32F4 it is the `arm`</div>
<div class="line"># https://cmake.org/cmake/help/latest/variable/CMAKE_SYSTEM_PROCESSOR.html</div>
<div class="line">set(CMAKE_SYSTEM_PROCESSOR arm)</div>
<div class="line"> </div>
<div class="line"># Set the compiler executables for cross compilation. (Optional: add the full path if you do not have them in the systems path)</div>
<div class="line">set(CMAKE_C_COMPILER &quot;arm-none-eabi-gcc.exe&quot;)</div>
<div class="line">set(CMAKE_CXX_COMPILER &quot;arm-none-eabi-g++.exe&quot;)</div>
<div class="line">set(CMAKE_ASM_COMPILER &quot;arm-none-eabi-gcc.exe&quot;)</div>
<div class="line">set(CMAKE_OBJCOPY &quot;arm-none-eabi-objcopy.exe&quot;)</div>
<div class="line">set(CMAKE_SIZE &quot;arm-none-eabi-size.exe&quot;)</div>
<div class="line"> </div>
<div class="line"># Compile to a static library and no not link dynamically at runtime, because on bare-metal embedded targets there is nothing to link to dynamically.</div>
<div class="line">set(CMAKE_TRY_COMPILE_TARGET_TYPE STATIC_LIBRARY)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">###########################################</div>
<div class="line">#       Global Options for all targets</div>
<div class="line">###########################################</div>
<div class="line"> </div>
<div class="line"># Set target architecture and cpu specific parameters</div>
<div class="line">#</div>
<div class="line"># Description of the compile options:</div>
<div class="line">#   https://gcc.gnu.org/onlinedocs/gcc/ARM-Options.html</div>
<div class="line">#</div>
<div class="line"># PM0214 STM32 Cortex®-M4 MCUs and MPUs programming manual 10.0 </div>
<div class="line">#   https://www.st.com/resource/en/programming_manual/pm0214-stm32-cortexm4-mcus-and-mpus-programming-manual-stmicroelectronics.pdf</div>
<div class="line">#</div>
<div class="line"># RM0390 STM32F446xx advanced Arm®-based 32-bit MCUs 6.0 </div>
<div class="line">#   https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf</div>
<div class="line"> </div>
<div class="line">set(CPU_FLAGS </div>
<div class="line">    &quot;-mcpu=cortex-m4&quot;       # use cortex m4 instructions</div>
<div class="line">    &quot;-mthumb&quot;               # use 16-bit (Thumb) instead of 32-bit (full ARM) instructions | STM32 only supports Thumb</div>
<div class="line">    &quot;-mfpu=fpv4-sp-d16&quot;     # This specifies what floating-point hardware</div>
<div class="line">    &quot;-mfloat-abi=hard&quot;      # Generate hardware instructions for the floating-point hardware</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">add_compile_options(</div>
<div class="line">    ${CPU_FLAGS}</div>
<div class="line"> </div>
<div class="line">    # use small c library implementation</div>
<div class="line">    --specs=nano.specs </div>
<div class="line"> </div>
<div class="line">    # Place functions and data in separate sections to allow linker garbage collection.</div>
<div class="line">    -ffunction-sections  </div>
<div class="line">    -fdata-sections      </div>
<div class="line"> </div>
<div class="line">    # do not store the frame pointer and make room for another register. Enables optimisations for performance.</div>
<div class="line">    -fomit-frame-pointer  </div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># Add link options to all files</div>
<div class="line">add_link_options(</div>
<div class="line">    # pass the CPU flags to the linker so it knows how to link correctly</div>
<div class="line">    ${CPU_FLAGS}</div>
<div class="line">    </div>
<div class="line">    # add the linker script that the IDE provided</div>
<div class="line">    -Wl,-T${CMAKE_SOURCE_DIR}/STM32F446RETX_FLASH.ld</div>
<div class="line">    </div>
<div class="line">    # tell the linker to delete and garbage collect section dead code</div>
<div class="line">    -Wl,--gc-sections </div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># Add libraries that can be used by all files</div>
<div class="line">link_libraries(</div>
<div class="line">    nosys   # Minimal system stubs for functions like: of functions like `write()`, `read()`, `_exit()`, `sbrk()`, etc.</div>
<div class="line">    gcc     # Compiler runtime support for operations not directly supported by hardware.</div>
<div class="line">    c_nano  # A reduced-size version of the standard C library </div>
<div class="line">    m       # Provides functions like `sin()`, `cos()`, `sqrt()`, `pow()`, etc.</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># Add CPU specific definitions - especially for the auto generated vendor files</div>
<div class="line">add_compile_definitions(</div>
<div class="line">    USE_HAL_DRIVER</div>
<div class="line">    STM32F446xx</div>
<div class="line">)</div>
</div><!-- fragment --><p>This sets up the proper compiler, target architecture, flags, and memory configuration for your STM32F4 MCU.</p>
<p>Now set up your <code>Application/CMakeLists.txt</code>. Two common practices are either in a sub folder (which this tutorial is doing) or as a seperate library in a seperate repo. </p><div class="fragment"><div class="line"># Includ the package manager from: https://github.com/cpm-cmake/CPM.cmake</div>
<div class="line">include(cmake/CPM.cmake)</div>
<div class="line"> </div>
<div class="line"># Optional: Enable system call stubs for freestanding/bare-metal for Fiber</div>
<div class="line">set(FIBER_USE_SYS_STUBS ON CACHE BOOL &quot;&quot; FORCE)</div>
<div class="line"> </div>
<div class="line"># Add the Fiber library</div>
<div class="line">CPMAddPackage(&quot;gh:TobiasWallner/Fiber#main&quot;)</div>
<div class="line"> </div>
<div class="line"># create the actual application. </div>
<div class="line"># It will contain generic code that can then be used by many boards and mcus</div>
<div class="line">add_library(App STATIC</div>
<div class="line">    app.cpp</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># link fiber to the application</div>
<div class="line">target_link_libraries(App PRIVATE fiber)</div>
<div class="line"> </div>
<div class="line"># optionally: if `FIBER_USE_SYS_STUBS ON`. !!! Has to link PUBLIC !!!</div>
<div class="line">target_link_libraries(App PUBLIC fiber_sys_stubs)</div>
</div><!-- fragment --><h1><a class="anchor" id="section_getting_started_stm32_makefile"></a>
Create a Makefile for easy CLI (Command Line Interface) builds</h1>
<p>Instead of typing long CMake commands, create a Makefile to simplify your workflow:</p>
<p>If you are no windows and do not have <code>make</code> available, you can get it like so</p>
<ol type="1">
<li>Download MSYS2 from their homepage: <a href="https://www.msys2.org/">https://www.msys2.org/</a></li>
<li>Open the MSYS2 shell</li>
<li>Update the package manager <code>pacman</code> <div class="fragment"><div class="line">pacman -Syu</div>
</div><!-- fragment --></li>
<li>Install make <div class="fragment"><div class="line">pacman -S make</div>
</div><!-- fragment --></li>
<li>Add the msys2 make directory <code>C:\msys64\usr\bin</code> to the PATH so you can use it in your host systems terminals</li>
</ol>
<p>For this particular makefile I chose to use Ninja as a generator. This just tells CMake to create Ninja flags. You can get Ninja from here: <a href="https://ninja-build.org/">https://ninja-build.org/</a></p>
<p>For flashing the make file uses the <code>STM32_Programmer_CLI</code>. You can download it from here: <a href="https://www.st.com/en/development-tools/stm32cubeprog.html">https://www.st.com/en/development-tools/stm32cubeprog.html</a> or use the one provided by the vendor IDE</p>
<p>Additionally, this Makefile uses a custom python script (introduced later) that calculates the used FLASH and RAM.</p>
<div class="fragment"><div class="line">#####################################</div>
<div class="line">#           Variables</div>
<div class="line">#####################################</div>
<div class="line"> </div>
<div class="line">STM32_Programmer_CLI = STM32_Programmer_CLI.exe</div>
<div class="line"> </div>
<div class="line">gcc_size = arm-none-eabi-size</div>
<div class="line">gcc_nm = arm-none-eabi-nm</div>
<div class="line"> </div>
<div class="line">build_dir = build</div>
<div class="line">config = Release</div>
<div class="line">target = main</div>
<div class="line">test_target = test</div>
<div class="line">linker_script = STM32F446RETX_FLASH.ld</div>
<div class="line"> </div>
<div class="line">#####################################</div>
<div class="line">#           Commands</div>
<div class="line">#####################################</div>
<div class="line"> </div>
<div class="line">.PHONY: help</div>
<div class="line">help: </div>
<div class="line">    $(info Make Commands:)</div>
<div class="line">    $(info --------------)</div>
<div class="line">    $(info build .......... builds the &#39;target&#39; with the &#39;config&#39;)</div>
<div class="line">    $(info flash .......... builds the &#39;target&#39; with the &#39;config&#39; and then flashes the binary to the micro-controller)</div>
<div class="line">    $(info test ........... convenience command that executest flash with the &#39;test_target&#39;)</div>
<div class="line">    $(info )</div>
<div class="line">    $(info Optional Arguments:)</div>
<div class="line">    $(info ---------------)</div>
<div class="line">    $(info build_dir= ...... sets the build directory. Default: $(build_dir))</div>
<div class="line">    $(info config= ........ sets the build type: &#39;Release&#39; or &#39;Debug&#39;. Default: $(config))</div>
<div class="line">    $(info target= ........ sets the target/CMake executable. Default: $(target))</div>
<div class="line">    $(info test_target= ... sets the target/CMake executable. Default: $(test_target))</div>
<div class="line"> </div>
<div class="line"># CMAKE Setup</div>
<div class="line"># -----------</div>
<div class="line">.PHONY: setup_cmake</div>
<div class="line">setup_cmake:</div>
<div class="line">    $(info )</div>
<div class="line">    $(info ================================ [build_dir: ./$(build_dir)/ | target: $(target) | config: $(config)] ================================)</div>
<div class="line">    $(info )</div>
<div class="line">    cmake -S . -B $(build_dir) -G &quot;Ninja Multi-Config&quot; -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake -DFIBER_COMPILE_TESTS=ON</div>
<div class="line">    </div>
<div class="line"># build commands</div>
<div class="line"># --------------</div>
<div class="line"> </div>
<div class="line"># build run target</div>
<div class="line">.PHONY: build</div>
<div class="line">build: setup_cmake</div>
<div class="line">    cmake --build $(build_dir) --target $(target) --config $(config)</div>
<div class="line">    $(gcc_size) --format=berkeley &quot;$(build_dir)/$(config)/$(target).elf&quot; &gt; &quot;$(build_dir)/$(config)/$(target)_size.txt&quot;</div>
<div class="line">    python stats.py -l $(linker_script) -s &quot;$(build_dir)/$(config)/$(target)_size.txt&quot;</div>
<div class="line">    $(gcc_nm) --size --print-size --radix=d &quot;$(build_dir)/$(config)/$(target).elf&quot; &gt; &quot;$(build_dir)/$(config)/$(target)_fsize.txt&quot;</div>
<div class="line"> </div>
<div class="line"># flash run target</div>
<div class="line">.PHONY: flash</div>
<div class="line">flash: build</div>
<div class="line">    ${STM32_Programmer_CLI} -c port=SWD -d &quot;$(build_dir)/$(config)/$(target).elf&quot; -v -rst</div>
<div class="line">    </div>
<div class="line">.PHONY: test</div>
<div class="line">test: build</div>
<div class="line">    @make flash target=$(test_target)</div>
<div class="line"> </div>
<div class="line">.PHONY: openocd</div>
<div class="line">openocd: build_run_debug</div>
<div class="line">    openocd -f openocd.cfg</div>
<div class="line"> </div>
<div class="line">.PHONY: gdb</div>
<div class="line">gdb:</div>
<div class="line">    arm-none-eabi-gdb &quot;$(build_dir)/$(config)/$(target).elf&quot;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">.PHONY: clean</div>
<div class="line">clean:</div>
<div class="line">    cmake --build build --target clean --config Release</div>
<div class="line">    cmake --build build --target clean --config Debug</div>
</div><!-- fragment --><p>This lets you run commands like:</p>
<ul>
<li><code>make build</code> to build the project</li>
<li><code>make flash</code> to flash the binary</li>
<li><code>make test</code> to test binaries</li>
</ul>
<p>You'll also probably want this Python script stats.py that calculate memory FLASH and RAM usage of your application code: </p><div class="fragment"><div class="line"><span class="keyword">import</span> re</div>
<div class="line"><span class="keyword">import</span> argparse</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>parse_bytes(size_str):</div>
<div class="line">    size_str = size_str.strip().upper()</div>
<div class="line">    units = {<span class="stringliteral">&quot;K&quot;</span>: 1024, <span class="stringliteral">&quot;k&quot;</span> : 1024, <span class="stringliteral">&quot;M&quot;</span>: 1024**2, <span class="stringliteral">&quot;G&quot;</span>: 1024**3, <span class="stringliteral">&quot;T&quot;</span>: 1024**4}</div>
<div class="line"> </div>
<div class="line">    num = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">    unit = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">    <span class="keywordflow">for</span> char <span class="keywordflow">in</span> size_str:</div>
<div class="line">        <span class="keywordflow">if</span> char.isdigit() <span class="keywordflow">or</span> char == <span class="stringliteral">&quot;.&quot;</span>:</div>
<div class="line">            num += char</div>
<div class="line">        <span class="keywordflow">else</span>:</div>
<div class="line">            unit += char</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> num:</div>
<div class="line">        <span class="keywordflow">raise</span> ValueError(f<span class="stringliteral">&quot;Invalid size format: {size_str}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    num = float(num)  <span class="comment"># Support decimal sizes like 1.5M</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> int(num * units.get(unit, 1))</div>
<div class="line"> </div>
<div class="line"><span class="comment"># get arguments</span></div>
<div class="line">parser = argparse.ArgumentParser(</div>
<div class="line">                    prog=<span class="stringliteral">&#39;stats&#39;</span>,</div>
<div class="line">                    description=<span class="stringliteral">&#39;Provides statistics from binary files&#39;</span>)</div>
<div class="line"> </div>
<div class="line">parser.add_argument(<span class="stringliteral">&#39;-l&#39;</span>, <span class="stringliteral">&#39;--linker_script&#39;</span>, help=<span class="stringliteral">&#39;Path to the linker script&#39;</span>)</div>
<div class="line">parser.add_argument(<span class="stringliteral">&#39;-s&#39;</span>, <span class="stringliteral">&#39;--size_file&#39;</span>, help=<span class="stringliteral">&#39;Path to the size file&#39;</span>)</div>
<div class="line"> </div>
<div class="line">args = parser.parse_args()</div>
<div class="line">print(f<span class="stringliteral">&quot;args: {args}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># read linker script</span></div>
<div class="line"><span class="keyword">with</span> open(args.linker_script, <span class="stringliteral">&quot;r&quot;</span>) <span class="keyword">as</span> linker_script:</div>
<div class="line">    linker_stript_str = linker_script.read()</div>
<div class="line">        </div>
<div class="line"><span class="comment"># extract the ram size</span></div>
<div class="line">regex_ram = <span class="stringliteral">r&#39;RAM.*LENGTH\s*=\s*(.*)\s&#39;</span></div>
<div class="line">match = re.search(regex_ram, linker_stript_str)</div>
<div class="line">ram_str = match.group(1)</div>
<div class="line">ram_size = parse_bytes(ram_str)/1024</div>
<div class="line"> </div>
<div class="line"><span class="comment"># extract the flah size</span></div>
<div class="line">regex_flash = <span class="stringliteral">r&#39;FLASH.*LENGTH\s*=\s*(.*)\s&#39;</span></div>
<div class="line">match = re.search(regex_flash, linker_stript_str)</div>
<div class="line">flash_str = match.group(1)</div>
<div class="line">flash_size = parse_bytes(flash_str)/1024</div>
<div class="line"> </div>
<div class="line"><span class="comment"># read size file</span></div>
<div class="line"><span class="keyword">with</span> open(args.size_file, <span class="stringliteral">&quot;r&quot;</span>) <span class="keyword">as</span> size_file:</div>
<div class="line">    lines = size_file.readlines()</div>
<div class="line">    text_str, data_str, bss_str, dec_str, hex_str, filename = map(str, lines[1].split())</div>
<div class="line"> </div>
<div class="line"><span class="comment"># sizes converted to kB</span></div>
<div class="line">text_size = parse_bytes(text_str)/1024.</div>
<div class="line">data_size = parse_bytes(data_str)/1024.</div>
<div class="line">bss_size = parse_bytes(bss_str)/1024.</div>
<div class="line">dec_size = parse_bytes(dec_str)/1024.</div>
<div class="line"> </div>
<div class="line">ram_used = bss_size + data_size</div>
<div class="line">flash_used = (text_size + data_size)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">print(<span class="stringliteral">&quot;\n--------------------------- Memory Usage in kB: ---------------------------&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;filename: {filename}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;.text: {text_size:.1f}, .data: {data_size:.1f}, .bss: {bss_size:.1f}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Ram:   .bss + .data  = {ram_used:.1f}\tof\t{ram_size:.0f}\t{ram_used*100/ram_size :.1f}%&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Flash: .text + .data = {flash_used:.1f}\tof\t{flash_size:.0f}\t{flash_used*100/flash_size :.1f}%\n&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;------------------------------------ Legend -------------------------------&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;.text (Code Segment): Contains the compiled machine code&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;.data (Initialized Data Segment): Holds initialized global and static variables.&quot;</span>)</div>
<div class="line">print(<span class="stringliteral">&quot;.bss (Uninitialized Data Segment): Contains uninitialized global and static variables.\n&quot;</span>)</div>
</div><!-- fragment --><h1><a class="anchor" id="section_getting_started_stm32_vscode"></a>
Setup VSCode for Development + Debugging</h1>
<p>Though the above make files allow for an easy build process using the terminal, vscode offers some nice to have features that let you step through your code in the debugger.</p>
<p>To enable those features we will setup a GDB server and connect to the MCU over OpenOCD.</p>
<p>Place the following config files in a <code>.vscode/</code> folder:</p>
<p>Debug Configuration <code>.vscode/launch.json</code></p>
<div class="fragment"><div class="line">&quot;version&quot;: &quot;0.2.0&quot;,</div>
<div class="line">&quot;configurations&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;name&quot;: &quot;STM32 Debug&quot;,</div>
<div class="line">        &quot;type&quot;: &quot;cortex-debug&quot;,</div>
<div class="line">        &quot;request&quot;: &quot;attach&quot;,</div>
<div class="line">        &quot;servertype&quot;: &quot;openocd&quot;,</div>
<div class="line">        &quot;configFiles&quot;: [&quot;openocd.cfg&quot;],</div>
<div class="line">        &quot;cwd&quot;: &quot;${workspaceRoot}&quot;,</div>
<div class="line">        &quot;executable&quot;: &quot;${workspaceRoot}/build/Debug/main.elf&quot;,</div>
<div class="line">        &quot;gdbTarget&quot;: &quot;localhost:3333&quot;,</div>
<div class="line">        &quot;showDevDebugOutput&quot;: &quot;raw&quot;,</div>
<div class="line">        &quot;runToEntryPoint&quot;: &quot;main&quot;,</div>
<div class="line">        &quot;preLaunchTask&quot;: &quot;flash-debug&quot;</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --><p>Build Task for Debugging <code>.vscode/tasks.json</code></p>
<div class="fragment"><div class="line">&quot;version&quot;: &quot;2.0.0&quot;,</div>
<div class="line">&quot;tasks&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;label&quot;: &quot;flash-debug&quot;,</div>
<div class="line">        &quot;type&quot;: &quot;shell&quot;,</div>
<div class="line">        &quot;command&quot;: &quot;make&quot;,</div>
<div class="line">        &quot;args&quot;: [&quot;flash&quot;, &quot;config=Debug&quot;],   // Calls the `debug` target in Makefile</div>
<div class="line">        &quot;group&quot;: {</div>
<div class="line">            &quot;kind&quot;: &quot;build&quot;,</div>
<div class="line">            &quot;isDefault&quot;: true</div>
<div class="line">        },</div>
<div class="line">        &quot;problemMatcher&quot;: [&quot;$gcc&quot;]</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --><p>Also create an OpenOCD configuration file to define your probe and target: </p><div class="fragment"><div class="line">source [find &quot;interface/stlink.cfg&quot;]</div>
<div class="line">source [find &quot;target/stm32f4x.cfg&quot;]</div>
<div class="line"> </div>
<div class="line">reset_config srst_only</div>
<div class="line">init</div>
<div class="line">reset init</div>
</div><!-- fragment --><hr  />
<p>You now have a clean and modern embedded development setup that, is portable, works across operating systems, avoids vendor lock-in, offers full integration with advanced tooling like GDB, OpenOCD, and VSCode and is easily integrateable it into a CD/CI system on e.g.: GitHub or GitLab.</p>
<p>This approach helps you scale your codebase, reuse your setup across projects, and work just like you would in a modern software engineering environment.</p>
<p>To implement CD/CI with automatic testing on pushing to the repo when working with GitHub:</p>
<ol type="1">
<li>create a folder called <code>.github</code> (has to be the exact name)</li>
<li>create a folder called <code>.github/workflows</code> (has to be the exact name)</li>
<li>create a workflow file e.g: <code>test.yml</code></li>
<li>write a script that compiles your project and executes the tests. Since cmake already does most of the work, that <code>test.yml</code> can be fairly small.</li>
</ol>
<p><code>.github/workflows/test.yml</code> </p><div class="fragment"><div class="line">name: test</div>
<div class="line"> </div>
<div class="line">on:</div>
<div class="line">  push:</div>
<div class="line">  pull_request:</div>
<div class="line"> </div>
<div class="line">jobs:</div>
<div class="line">  test:</div>
<div class="line">    runs-on: ubuntu-latest</div>
<div class="line"> </div>
<div class="line">    env:</div>
<div class="line">      BUILD_TYPE: Release</div>
<div class="line"> </div>
<div class="line">    steps:</div>
<div class="line">    - uses: actions/checkout@main</div>
<div class="line"> </div>
<div class="line">    - name: Install dependencies</div>
<div class="line">      run: |</div>
<div class="line">        sudo apt update</div>
<div class="line">        sudo apt install ninja-build cmake</div>
<div class="line">        sudo apt install g++ # Just in case</div>
<div class="line"> </div>
<div class="line">    - name: Set up compiler</div>
<div class="line">      run: |</div>
<div class="line">          echo &quot;CC=gcc&quot; &gt;&gt; $GITHUB_ENV</div>
<div class="line">          echo &quot;CXX=g++&quot; &gt;&gt; $GITHUB_ENV</div>
<div class="line"> </div>
<div class="line">    - name: Configure with CMake</div>
<div class="line">      run: cmake -S . -B build -G &quot;Ninja Multi-Config&quot;</div>
<div class="line"> </div>
<div class="line">    - name: Build</div>
<div class="line">      run: cmake --build build --config Release</div>
<div class="line"> </div>
<div class="line">    - name: Run CTest</div>
<div class="line">      run: ctest --test-dir build -C Release -V</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d1/d66/getting_started.html">Getting Started</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
