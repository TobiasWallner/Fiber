<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fiber: Overflow aware: Clocks, Time-Points and Durations</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">fiber
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d8/dd3/page_overflow_aware_clocks.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Overflow aware: Clocks, Time-Points and Durations</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="page_exceptions_and_assertions_disable"></a>
Disable all checks and assertions</h1>
<h1><a class="anchor" id="autotoc_md50"></a>
TODO: Rewrite for new <code>TimePoint</code> and <code>Duration</code></h1>
<p>The <code>fiber</code> library provides a fully overflow-aware timing system including:</p><ul>
<li>Clocks</li>
<li>Time points</li>
<li>Durations</li>
</ul>
<p>These types integrate seamlessly with the C++ <code>&lt;chrono&gt;</code> standard library while being specifically optimized for bare-metal embedded systems. They allow safe and precise tracking of time using wraparound counters (hardware timer-style), while preserving intuitive arithmetic and comparison operations.</p>
<hr  />
<h1><a class="anchor" id="page_overflow_aware_clocks_overflow_awareness"></a>
Overflow Awareness</h1>
<p>Unlike the standard <code>std::chrono</code> types which assume linear time, <code>fiber</code>’s types are built on <code>ClockTick</code>, which wraps and tracks tick values modulo an overflow:</p>
<ul>
<li>Overflow handling is transparent.</li>
<li>All operations (e.g., <code>a &lt; b</code>, <code>b - a</code>) work correctly even when the counter has wrapped.</li>
<li>Tick differences and time comparisons are reliable as long as differences are <b>less than half the overflow window</b>.</li>
</ul>
<blockquote class="doxtable">
<p>This means the clock counter must count to <b>at least double</b> the maximum interval between two time points that are to be reliably compared. </p>
</blockquote>
<p>Note: The library is heavily optimised to avoid modulo operations and divisions. The fastest is to always use the full range of the integer datatype. If your hardware timer does not cover the full range, for example a 10 or 24-bit counter, then always make sure that the counter overflows on a power of 2 / the maximal value is 2^n-1. ⚠️ If arbitrary overflows are used, the library will use additional modulo operations, but only for constructions (can be mittigated by using <code>ClockTick::reinterpret</code>) and multiplication.</p>
<hr  />
<h1><a class="anchor" id="page_overflow_aware_clocks_overflow_integration_with_stdchrono"></a>
Integration with <code>&lt;chrono&gt;</code></h1>
<p><code><a class="el" href="../../d9/d07/classfiber_1_1_duration.html" title="Overflow aware duration for hardware timers/counters.">fiber::Duration</a></code>, <code><a class="el" href="../../db/d7f/classfiber_1_1_time_point.html" title="Overflow aware point in time for hardware timers/counters.">fiber::TimePoint</a></code>, and <code>fiber::Clock</code> all follow the exact semantics and layout of their standard counterparts:</p><ul>
<li><code><a class="el" href="../../d9/d07/classfiber_1_1_duration.html" title="Overflow aware duration for hardware timers/counters.">fiber::Duration</a></code> is a wrapper around <code>std::chrono::duration</code> using <code>ClockTick</code> as its representation type.</li>
<li><code><a class="el" href="../../db/d7f/classfiber_1_1_time_point.html" title="Overflow aware point in time for hardware timers/counters.">fiber::TimePoint</a></code> wraps <code>std::chrono::time_point</code> using your chosen <code>Clock</code>.</li>
<li>All durations can be converted using <code>std::chrono::duration_cast</code> or <code><a class="el" href="../../d3/d96/namespacefiber.html#aac4ef3d952aa013d37e29d3e2da57244" title="duration cast that round to the nearest tick of the new ToDuration">fiber::rounding_duration_cast</a></code>.</li>
</ul>
<p>You can freely mix <code>fiber</code> clocks with standard <code>std::chrono</code> durations where appropriate.</p>
<hr  />
<h1><a class="anchor" id="page_overflow_aware_clocks_overflow_awareness_example"></a>
Example: Creating Your Own Clock</h1>
<p>Creating a custom hardware-aware overflow-safe clock is extremely simple. All you need to provide is:</p><ul>
<li>the <b>underlying integer type</b> of your timer register (e.g. <code>uint32_t</code>)</li>
<li>a <code>std::ratio</code> expressing its period relative to <code>1s</code> (e.g. <code>std::micro</code> if each tick represents a micro second)</li>
<li>a <code>constexpr</code> function that returns the current counter value</li>
<li><em>(optional)</em> the maximum value that the counter reaches before wrapping (default is the max of the type)</li>
</ul>
<h3><a class="anchor" id="autotoc_md54"></a>
✔️ Full-range timer:</h3>
<div class="fragment"><div class="line">uint32_t get_timer_count(); <span class="comment">// your hardware counter</span></div>
<div class="line"><span class="keyword">using </span>MyClock = fiber::Clock&lt;uint32_t, std::micro, get_timer_count&gt;;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md55"></a>
✔️ Timer that wraps at a custom maximum (e.g., 1023):</h3>
<div class="fragment"><div class="line"><span class="keyword">using </span>MyClock = fiber::Clock&lt;uint32_t, std::micro, get_timer_count, 1024-1&gt;;</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>⚠️ The fourth template argument is the <b>maximum value the counter counts to</b>, <em>not</em> the value <em>after</em> overflow. </p>
</blockquote>
<p>Once defined, you can use this clock directly: </p><div class="fragment"><div class="line">MyClock::time_point start = MyClock::now();</div>
<div class="line">...</div>
<div class="line">MyClock::time_point now = MyClock::now();</div>
<div class="line"><a class="code hl_class" href="../../d9/d07/classfiber_1_1_duration.html">fiber::Duration&lt;uint32_t, std::micro&gt;</a> elapsed = now - start;</div>
<div class="line">...</div>
<div class="line">fiber::Scheduler&lt;MyClock&gt; rtscheduler;</div>
<div class="line">rtscheduler.addTask(task);</div>
<div class="ttc" id="aclassfiber_1_1_duration_html"><div class="ttname"><a href="../../d9/d07/classfiber_1_1_duration.html">fiber::Duration</a></div><div class="ttdoc">Overflow aware duration for hardware timers/counters.</div><div class="ttdef"><b>Definition</b> Duration.hpp:42</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="page_overflow_aware_clocks_overflow_awareness_why"></a>
Why Use This?</h1>
<ul>
<li>Fully portable overflow handling — just like hardware timers</li>
<li>Clean, standard-compliant chrono API</li>
<li>Backed by real unit tests with corner-case handling (<code><a class="el" href="../../d2/d0a/_clock__test_8cpp.html">Clock_test.cpp</a></code>)</li>
<li>Integrates easily into <code>Fiber</code> or any cooperative scheduler</li>
<li>Avoids common embedded bugs with counter wraparound and time comparison</li>
</ul>
<h1><a class="anchor" id="page_overflow_aware_clocks_summary"></a>
Summary</h1>
<p><code>fiber</code> makes working with microcontroller timers as safe and intuitive as modern C++ chrono types — without giving up performance or hardware alignment. You keep full control over the tick source, overflow range, and resolution, and the library guarantees that comparisons and arithmetic Just Work™.</p>
<dl class="section see"><dt>See also</dt><dd>fiber::ClockTick </dd>
<dd>
<a class="el" href="../../db/d7f/classfiber_1_1_time_point.html" title="Overflow aware point in time for hardware timers/counters.">fiber::TimePoint</a> </dd>
<dd>
<a class="el" href="../../d9/d07/classfiber_1_1_duration.html" title="Overflow aware duration for hardware timers/counters.">fiber::Duration</a> </dd>
<dd>
fiber::CClock </dd>
<dd>
fiber::Clock </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
